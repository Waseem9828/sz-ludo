rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
  
    // Helper function to check for admin roles
    function isAdmin() {
      return request.auth != null && request.auth.token.role in ['superadmin', 'finance', 'support'];
    }

    // Default deny all access
    match /{allPaths=**} {
      allow read, write: if false;
    }
    
    // DEPOSITS: Allow users to upload screenshots into their own folder.
    // Path: /deposits/{userId}/{fileName}
    match /deposits/{userId}/{fileName} {
      // User can create, read, and delete their own deposit screenshots.
      // Admins can read any deposit screenshot.
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // SCREENSHOTS: Allow users to upload game-winning screenshots.
    // Path: /screenshots/{gameId}/{fileName}
    match /screenshots/{gameId}/{fileName} {
      // Any authenticated user can upload a game screenshot.
      // The firestore rules for the game document will determine if the user is a valid player.
      allow write: if request.auth != null;
      allow read: if request.auth != null; // Allow players and admins to view.
    }
    
    // BANNERS: Allow anyone to read, but only admins to write.
    // Path: /banners/{folder}/{fileName}
    match /banners/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // TOURNAMENTS: Allow anyone to read images, but only admins to write.
    // Path: /tournaments/{fileName}
    match /tournaments/{fileName} {
        allow read: if true;
        allow write: if isAdmin();
    }
  }
}
